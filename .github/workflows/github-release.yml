name: Role Release (create GitHub release)

on:
  workflow_run:
    workflows: ["Version Bump Enforcement"]
    types:
      - completed
    branches:
      - main

  pull_request:
    branches:
      - main
    types:
      - closed

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    # This job runs either when the bump workflow finishes successfully (workflow_run)
    # or when a tag matching vX.Y.Z is pushed directly.
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve tag (workflow_run or push)
        id: resolve_tag
        run: |
          # If triggered by workflow_run, find the tag that points at that run's head SHA
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            HEAD_SHA=${{ github.event.workflow_run.head_sha }}
            TAG=$(git tag --points-at "$HEAD_SHA" | grep '^v[0-9]\+\.[0-9]\+\.[0-9]\+$' || echo "")
            if [ -n "$TAG" ]; then
              echo "tag=$TAG" >> "$GITHUB_OUTPUT"
              echo "source=workflow_run" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            # fallback: attempt to read version from galaxy.yml
            TAG=""
          fi

          # If triggered by a push tag event, use GITHUB_REF
          if [[ "${GITHUB_REF}" =~ ^refs/tags/(v[0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            TAG="${BASH_REMATCH[1]}"
            echo "tag=$TAG" >> "$GITHUB_OUTPUT"
            echo "source=push" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Last resort: try to read version from galaxy.yml and find corresponding tag
          if [ -f galaxy.yml ]; then
            VERSION=$(grep '^version:' galaxy.yml | awk '{print $2}' || echo "")
            if [ -n "$VERSION" ]; then
              TAG="v${VERSION}"
              if git rev-parse "$TAG" >/dev/null 2>&1; then
                echo "tag=$TAG" >> "$GITHUB_OUTPUT"
                echo "source=galaxy_yml" >> "$GITHUB_OUTPUT"
                exit 0
              fi
            fi
          fi

          echo "tag=" >> "$GITHUB_OUTPUT"
          echo "source=none" >> "$GITHUB_OUTPUT"

      - name: Abort if no tag found
        if: steps.resolve_tag.outputs.tag == ''
        run: |
          echo "No semantic tag found to release; exiting."
          exit 0

      - name: Determine role and namespace
        id: meta
        run: |
          # namespace default: repository owner (use literal 'tpe' if you prefer hardcoding)
          NAMESPACE=${{ github.repository_owner }}
          ROLE_NAME=${GITHUB_REPOSITORY##*/}
          echo "namespace=${NAMESPACE}" >> "$GITHUB_OUTPUT"
          echo "role_name=${ROLE_NAME}" >> "$GITHUB_OUTPUT"

      - name: Generate release notes (commit messages)
        id: notes
        run: |
          TAG=${{ steps.resolve_tag.outputs.tag }}
          # get latest tag before this tag (if any)
          PREV_TAG=$(git describe --tags --abbrev=0 "${TAG}^" 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            # commits between prev tag (exclusive) and this tag (inclusive)
            NOTES=$(git log --pretty=format:"- %s" "$PREV_TAG".."$TAG")
          else
            NOTES=$(git log --pretty=format:"- %s" "$TAG")
          fi
          # fallback if empty
          if [ -z "$NOTES" ]; then
            NOTES="- Release $TAG"
          fi
          echo "notes<<EOF" >> "$GITHUB_OUTPUT"
          echo "$NOTES" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Create GitHub release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.resolve_tag.outputs.tag }}
          release_name: Release ${{ steps.resolve_tag.outputs.tag }}
          body: ${{ steps.notes.outputs.notes }}
          draft: false
          prerelease: false
